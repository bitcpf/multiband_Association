\subsection{Challenges And Analysis}
\label{subsec:challenge}
% Connect the model to the system,
% Claim the variables which we made to do the optimize
% Explain the way to find mu in the words
% Challenges sum
Prior works formulate similar multi-channel systems as $M/M/m$ queuing systems for 
analysis~\cite{bodas2012low}. However, the heterogeneous WhiteCell system is not 
able to be formulated as such due to the non-equal assignment of channel capacity 
to each cell across white space and WiFi channels.
Thus we first analyze the queuing system and apply previous work in $M/M/m$ queuing 
theory to approach a solution for the system.

% introduce the queue system
In the heterogeneous WhiteCell system, the users of a cell have access to both the WiFi 
channel assigned for the cell and the larger propagation white space channels for service. 
The white space channels cover multiple cells in the system, thus the channel capacity of white space channels need to be split into these cells 
to server the users.
The division of white space channel capacities brings the capacity variation of the servers 
in the queuing model.
The white space channel capacity division and the spectrum capacity variation across cells 
might remove the equal service capacity assumption of the queuing system in most scenarios.
However, the equal server capacity is the pre-request for a general $M/M/m$ queuing system 
analysis. Thus, the $M/M/m$ queuing system of a multi-channel version is not directly applicable 
for this WhiteCell system model.

% User constraints
The response time $W$ represent the time duration from the user sending request to getting the 
server response. 
In the system design, the response time $W$ constraint has to be satisfied to 
keep the quality of service. 
% User diversity
The channel quality in multiple cells varies throughout a single time slot, which is mentioned as part 
of the multi-user diversity in previous works. Multi-user diversity is a form of diversity 
inherent in a wireless network, provided by independent time-varying channels across the different 
users~\cite{viswanath2002opportunistic}. 
The diversity could be generated by the interference from a device inside or outside of the network as well as environmental variations.  
% Channel capacity diversity
Some cells may have clean white space channels in the air while the other cells may suffer 
worse white space channel performance. 
To address the variation, instead of holding the on-off channel assumption, we utilize in-field 
measurements to infer channel capacity in this work.
% Activity level instruction
We define the activity level as the percentage of time occupied by the signal in the air based on the 
measurements to estimate the achieved channel capacity. 
We perform measurements to sense the activities in the air in multiple locations in north Texas 
through our portable spectrum analyzer.
The percentage of sensing samples ($S_\theta$) above an interference threshold ($\theta$) over the 
total samples ($S$) in a time unit is the activity level ($A$):
\begin{equation}
\label{eq:actdef}
A=\frac{S_\theta}{S_a}
\end{equation}
The capacity of a clean channel is denoted by $C$. With the protocol model, the achieved capacity 
of a channel $C_r$ could be represented as the remaining free time of the channel capacity 
according to Eq.~\ref{eq:intercap}: 
\begin{equation}
\label{eq:intercap}
C_r=C*(1-\bar{A})
\end{equation}

% User distribution measurements
The user mobility footprint is one of the key points in the wireless resource allocation. 
As more users stay in a cell, more wireless channel resources need to be allocated to the 
cell.
Thus, the user distribution is important for wireless network operating in resource allocation. 
The large propagation of white space channels is able to balance the non-uniform user distribution via 
channel capacity allocation.
To identify the user mobility patterns, we analyze the data set from WiEye, an Android application that 
reports the location, velocity, and signal information to leverage the mobility patterns of users during week days. The setup and results are shown in 
Section~\ref{sec:experiment}.

% analysis
With these measurements, we further analyze the channel capacity allocation for 
the WhiteCell heterogeneous system. 
We first investigate the channel capacity allocation sub problem in a single cell.
The users of the the same WiFi cell are in a heterogeneous queuing system with server of 
WiFi channels and white space channels with service rates $\mu_1,\mu_2,...\mu_{(F_w+1)}$.
$\mu$ denotes the capacity of a channel allocated in this cell.
There are multiple accessible channels in the cell: the WiFi channel and the 
white space channel divisions allocated to the cell.
The capacity of a white space channel division is usually 
the minimum share of channel capacity in a cell, which is an equal part of the WiFi channel capacity.
Thus, there are three cases of channel capacity comparisons in a single cell. 

The first case is one in which both WiFi and one or more white space channels works for the cell. 
The minimum capacity of some white space channel is several time less than the maximum channel 
capacity. The maximum channel capacity is usually from the WiFi channel, while the minimum capacity channel 
division is from one of the white space channels. 
As an example, in a single cell, a white space channel is assigned equally to two cells, while 
the WiFi channel of the cell works only for this cell. Thus, the capacity of the WiFi channel is 
about twice as much as the assigned white space channel capacity in this cell.
This case is a heterogeneous server queuing system with unequal server capacities.

The second case is one in which only a single channel serves the cell, either the WiFi channel or 
part of a single white space channel.
This case can be simplified to a $M/M/1$ queuing system that only has one server in the model.

The third case is one in which both WiFi channel and white space channels work for the cell. 
The capacity of all the assigned channel capacity have equal capacity.
This case is able to convert into a $M/M/m$ queuing system has multiple equal capacity server in the model.

For the first case, a heterogeneous server queuing system, we apply the transformation model 
in~\cite{yu2008transformation} to estimate the response time $\bar{w}$. 
In the transformation model, the actual arrival rate for one specific server $\lambda_s$ is 
defined as in Eq.~\ref{eq:actarrivalrate}
\begin{equation}
\label{eq:actarrivalrate}
\lambda_s=D_{cell}/(F_{cW}+F_{cM})
\end{equation}
$D_{cell}$ is the traffic aggregated from the users in the cell.
$F_{cW}$ represents the set of white space channels assigned in the cell, $F_{cM}$ notes the WiFi channels 
in the cell.


The other parameters are noted from Eq.~\ref{eq:transformation} to~\ref{eq:kvalue}.
\begin{equation}
\label{eq:transformation}
\mu_{min}=\min{(\mu_1,\mu_2,...\mu_{(F_w+1)})} = \bar{\mu}
\end{equation}

\begin{equation}
\mu_{max}=\max{(\mu_1,\mu_2,...\mu_{(F_w+1)})} 
\end{equation}

\begin{equation}
\label{eq:kvalue}
k= \lfloor\frac{\mu_{max}}{\mu_{min}} \rfloor
\end{equation}

When $k=1$, the system becomes a homogeneous $M/M/m$queuing system as in case three. Otherwise,   
$k\ge2$ the average response time of such a heterogeneous system~\cite{yu2008transformation} 
could be represented as in Eq.~\ref{eq:heterresponse}:

\begin{equation}
\label{eq:heterresponse}
\bar{w}=\frac{1}{\frac{1}{3}\bar{\mu}(2k+1)-\lambda_s}
\end{equation}

Through the transformation model, we can further calculate the channel capacity required for the response time constraints. 
Additionally, the power consumption can be calculated for the system.
When the traffic is able to be served by part of a single white space channel or the WiFi channel, as in
the second scenario, the system converges to a $M/M/1$ queue. The response time $\bar{w}$ 
can then be estimated from Eq.~\ref{eq:mm1w}~\cite{gelenbe1998introduction}.

\begin{equation}
\label{eq:mm1w}
\bar{w}=\frac{1}{\mu^+-D}
\end{equation}
$\mu^+$ represents the channel capacity of the single channel capacity allocated in the cell.

In the third scenario, the system becomes a $M/M/m$ queuing system. 
The average response time can be calculated as Eq.~\ref{eq:mmmw}~\cite{gelenbe1998introduction}.
\begin{equation}
\label{eq:mmmw}
\bar{w} = \frac{1}{\mu^*}(1+\frac{c(m,\rho)}{m(1-\rho)})\approx \frac{1}{\mu^*}\frac{1}{1-\rho^m}
\end{equation}
$\mu^*$ is the average capacity of channels in the $M/M/m$ queuing system.
A half search strategy is applied to find the minimum value of $\mu^*$ to reduce the transmit power
consumption.
$\rho=\frac{\lambda}{m\mu^*}$ is the traffic density, and $c(m,\rho)$ is the Erlang-C 
formula~\cite{gelenbe1998introduction}.



In the heterogeneous WhiteCell system, the less radios that are in operation, the less power consumption occurs 
in the system as shown in Eq.~\ref{eq:radio}. 
The basic idea of power saving for this heterogeneous system is to replace the WiFi radios via 
white space channel capacity. To implement the division of the white space capacity, we propose a 
Greedy Server-side Replace(GSR) algorithm to minimize power consumption in the system 
as shown in Algorithm~\ref{algorithm:gsr}. 

\begin{algorithm}[t]
\small
\caption{Greedy Server-side Replace}
\label{algorithm:gsr}
\begin{algorithmic}[1]
\REQUIRE  ~~\\
$N$: Users\\
$H_{i,j}^f$: Vector of channel capacity\\
$D$: Traffic Rate\\
$M$: WiFi Cells
\STATE {Find the WiFi cell with the lowest traffic rate $D$,break the tie with index}
\STATE {Calculate the power consumption according to Eq.~\ref{eq:heterresponse}~\ref{eq:mm1w}~\ref{eq:mmmw}}
\IF {If channel resource feasible and exist unserved traffic demand}
\STATE {List available options}
\IF {Single channel is the best}
\STATE Apply half-interval search to find the minimum capacity for the users
\ELSIF {Homogeneous is the best}
\STATE Allocate the resource for the cell
\STATE Keep the WiFi channel and find the minimum capacity for the users
\ELSIF {Heterogeneous is best}
\STATE Adding white space resource to the cell
\ENDIF
\ELSE 
\STATE Get the waiting time of the cell with all available resource
\ENDIF
\STATE Update the system information
\STATE Repeat the process for all the cells
\STATE Calculate the power consumption
\ENSURE ~~\\
The power consumption, resource allocation and the maximum waiting time\\
\end{algorithmic}
\end{algorithm}

The GSR algorithm inputs are the measurement-based achieved channel capacity, the user distribution 
information, the number of white space channels, and the WiFi cells. 
The more cells that can be served by a the largely propagated white space channel, the less radios need to 
be turned on.
To turn off more radios, the algorithm starts to replace the cell radios with white space channels in the 
cells with less traffic demands.
The algorithm compares the three configurations of channel capacity assignment in each cell and chooses the 
setup with the lowest power consumption. Further, the process is repeated until all traffic demand is served or the 
channel resources have been used up.
Finally, system outputs the power consumption and channel allocation of the system.

